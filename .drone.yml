pipeline:
  dependencies:
    image: node:erbium
    commands:
      - ./scripts/check-lockfile.sh

  lint:
    group: tests
    image: node:erbium
    commands:
      - yarn lint && yarn pretty:check

  jest:
    group: tests
    image: node:erbium
    commands:
      - yarn jest

  check-build:
    image: node:erbium
    secrets: [gh_token]
    commands: node scripts/failcheck.js
    when:
      status: [success, failure]

  deploy-twigjs-preview:
    group: previews
    image: node:erbium
    secrets: [gh_token, netlify_auth_token, netlify_js_site_id]
    commands:
      - yarn twing:clean
      - yarn twing:dist
      - 'yarn netlify deploy --site $${NETLIFY_JS_SITE_ID} --alias ${DRONE_COMMIT_BRANCH} --message "Drone build: ${CI_BUILD_NUMBER}"'
      - node scripts/set-netlify-deployment-status.js
    environment:
      - DEPLOY_CONTEXT=preview/twig-js
    when:
      event: push
      status: [success, failure]
      branch:
        exclude:
          - master

  deploy-prod-js:
    image: node:erbium
    secrets: [gh_token, netlify_auth_token, netlify_js_site_id]
    commands:
      - yarn twing:clean
      - yarn twing:dist
      - 'yarn netlify deploy --prod --site $${NETLIFY_JS_SITE_ID} --message "Drone build: ${CI_BUILD_NUMBER}"'
      - node scripts/set-netlify-deployment-status.js
    environment:
      - DEPLOY_CONTEXT=preview/twig-js
    when:
      branch: master
      event: push

  deploy-prod-php:
    image: roelofr/php-node
    secrets: [gh_token, netlify_auth_token, netlify_php_site_id]
    commands:
      - apt-get update
      - apt-get install -y libgbm1 gconf-service sed libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
      - which chromium
      - sed -i 's;exec -a "$0" "$HERE/chrome" "$@";exec -a "$0" "$HERE/chrome" "$@" --no-sandbox;g' /usr/bin/chromium
      - npm install -g n && n stable
      - yarn install
      - rm -rf netlify.toml
      - yarn php:install
      - yarn php:dist
      - 'yarn netlify deploy --prod --dir=php/dist --site $${NETLIFY_PHP_SITE_ID} --message "Drone build: ${CI_BUILD_NUMBER}"'
      - node scripts/set-netlify-deployment-status.js
    environment:
      - DEPLOY_CONTEXT=preview/twig-php
    when:
      branch: master
      event: push

  deploy-twigphp-preview:
    group: previews
    image: roelofr/php-node
    secrets: [gh_token, netlify_auth_token, netlify_php_site_id]
    commands:
      - apt-get update
      - apt-get install -y libgbm1 gconf-service libasound2 sed libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
      - which chromium
      - sed -i 's;exec -a "$0" "$HERE/chrome" "$@";exec -a "$0" "$HERE/chrome" "$@" --no-sandbox;g' /usr/bin/chromium
      - npm install -g n && n stable
      - yarn install
      - rm -rf netlify.toml
      - yarn php:install
      - yarn php:dist
      - yarn diff
      - 'yarn netlify deploy --dir=php/dist --site $${NETLIFY_PHP_SITE_ID} --alias ${DRONE_COMMIT_BRANCH} --message "Drone build: ${CI_BUILD_NUMBER}"'
      - node scripts/set-netlify-deployment-status.js
    environment:
      - DEPLOY_CONTEXT=preview/twig-php
    when:
      event: push
      status: [success, failure]
      branch:
        exclude:
          - master
